---
title: "Part A - SQL"
execute:
  echo: false
---

```{r Install dependencies}
#| echo: false
#| warning: false
if(!require('tidyverse'))
  packages.install('tidyverse')

if(!require('RSQLite'))
  packages.install('RSQLite')
```

# Core SQL Queries

### 1.   List the total budget allocated for projects in each country, along with the count of projects per country. Display sorted by the total budget in descending order

@tbl-projectbudgetspercountry presents the total budget allocated for projects in each country, along with the number of projects per country

```{r}
#| label: tbl-projectbudgetspercountry
#| tbl-cap: Project count and budget per country
#| echo: false
#| warning: false
#| cache: true
library("RSQLite")

## connect to db
con <- dbConnect(drv=RSQLite::SQLite(), dbname="ICA_2023.sqlite")

projectBudgets <- dbGetQuery(
  con,
  'SELECT
      CustomerCountry AS Country,
      SUM(Budget) AS \'TotalBudget\',
      COUNT(ProjectID) AS "ProjectCount"
  FROM Projects
      JOIN Customers C ON
          Projects.CustomerID = C.CustomerID
  GROUP BY CustomerCountry
  ORDER BY TotalBudget DESC;'
  )

dbDisconnect(con)

# TODO: Cross-references don't work with DT::datatable: https://github.com/quarto-dev/quarto-cli/discussions/6311
# Decide whether to implement a workaround or leave it as-is and hope an update to Quarto fixes it at some point in the future

# Show the first 8 rows + pagination
DT::datatable(projectBudgets, options = list(pageLength = 8))
```



### 2. List the average development time for projects, categorized by the number of assets used

@tbl-devtimebyassetsused presents the average development time for projects, grouped by the number of assets used

```{r}
#| label: tbl-devtimebyassetsused
#| tbl-cap: Average development time for projects, grouped by # of assets used
#| echo: false
#| warning: false
#| cache: true
library("RSQLite")

## connect to db
con <- dbConnect(drv=RSQLite::SQLite(), dbname="ICA_2023.sqlite")

avgDevTimeByAssetCount <- dbGetQuery(
  con,
  'SELECT
      AVG(DaysTaken) AS AverageDevTime,
      AssetCount
  FROM (
      SELECT
          COUNT(AssetID) AS AssetCount,
          (JULIANDAY(EndDate) - JULIANDAY(StartDate)) AS DaysTaken
      FROM Projects
          LEFT JOIN Assets A ON
              Projects.ProjectID = A.ProjectID
      GROUP BY Projects.ProjectID
  )
  GROUP BY AssetCount;'
  )

dbDisconnect(con)

# TODO: Cross-references don't work with DT::datatable: https://github.com/quarto-dev/quarto-cli/discussions/6311
# Decide whether to implement a workaround or leave it as-is and hope an update to Quarto fixes it at some point in the future

# Show the first 8 rows + pagination
DT::datatable(avgDevTimeByAssetCount, options = list(pageLength = 8))
```